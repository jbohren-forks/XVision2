<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta name="robots" content="noindex">
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>/home/burschka/XVision2-2.0.0/src/Tools/XVRectRaster.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.0 on Fri Oct 26 00:17:16 2007 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; </center>
<hr><h1>/home/burschka/XVision2-2.0.0/src/Tools/XVRectRaster.h</h1><div class="fragment"><pre>00001 <font class="preprocessor"># ifndef _XVRECTRASTER_H_
</font>00002 <font class="preprocessor"></font><font class="preprocessor"># define _XVRECTRASTER_H_
</font>00003 <font class="preprocessor"></font>
00004 <font class="comment">/*
</font>00005 <font class="comment">  This class rasterizes a parallelogram given three of its vertices and 
</font>00006 <font class="comment">  the numbers of points along the direction of both of two nearby edges: 
</font>00007 <font class="comment">  n_h points are taken along the edge between (x_0,y_0) and (x_h,y_h);
</font>00008 <font class="comment">  n_v points are taken along the edge between (x_0,y_0) and (x_v,y_v).
</font>00009 <font class="comment">  So totally n_h * n_v points are taken in the parallelogram.
</font>00010 <font class="comment">  Note that the edge between (x_0,y_0) and (x_h,y_h) and that between
</font>00011 <font class="comment">  (x_0,y_0) and (x_v,y_v) are considered ``inside'' the parallelogram, 
</font>00012 <font class="comment">  while the other two edges are considered ``outside''.
</font>00013 <font class="comment">*/</font>
00014 
00015 <font class="keyword">class </font>XVRectRaster {
00016  <font class="keyword">private</font>:
00017   <font class="keywordtype">int</font> x0, y0, xh, yh, xv, yv, h, v ;
00018   <font class="keywordtype">int</font> dxh, dyh, dxv, dyv, fdxh, fdyh, fdxv, fdyv, s, s2 ;
00019   <font class="keywordtype">int</font> i, j, x, y, fx, fy, rx, ry, frx, fry ;
00020  <font class="keyword">public</font>:
00021   XVRectRaster( <font class="keywordtype">int</font> x_0, <font class="keywordtype">int</font> y_0, <font class="keywordtype">int</font> x_h, <font class="keywordtype">int</font> y_h, 
00022           <font class="keywordtype">int</font> x_v, <font class="keywordtype">int</font> y_v, <font class="keywordtype">int</font> n_h, <font class="keywordtype">int</font> n_v ) : 
00023    x0(x_0), y0(y_0), xh(x_h), yh(y_h), xv(x_v), yv(y_v), h(n_h), v(n_v),
00024    dxh((xh-x0)/h), dyh((yh-y0)/h), dxv((xv-x0)/v), dyv((yv-y0)/v), 
00025    fdxh((xh-x0)%h*v*2), fdyh((yh-y0)%h*v*2), fdxv((xv-x0)%v*h*2), 
00026    fdyv((yv-y0)%v*h*2), s(h*v), s2(s*2), 
00027    i(0), j(0), x(x0), y(y0), fx(0), fy(0), rx(x0), ry(y0), frx(0), fry(0) {}
00028 
00029   <font class="comment">// return false when there is no more point to iterate, true otherwise</font>
00030 
00031   <font class="keywordtype">bool</font> next()<font class="keyword"> </font>{
00032     <font class="keywordflow">if</font>( ++i &gt;= h ) {
00033       <font class="keywordflow">return</font> nextLine() ;
00034     }<font class="keywordflow">else</font> {
00035       x += dxh ;
00036       fx += fdxh ;
00037       <font class="keywordflow">if</font>( fx &gt; s ) {
00038         fx -= s2 ;
00039         x ++ ;
00040       }<font class="keywordflow">else</font> <font class="keywordflow">if</font>( fx &lt;= -s ) {
00041         fx += s2 ;
00042         x -- ;
00043       }
00044       y += dyh ;
00045       fy += fdyh ;
00046       <font class="keywordflow">if</font>( fy &gt; s ) {
00047         fy -= s2 ;
00048         y ++ ;
00049       }<font class="keywordflow">else</font> <font class="keywordflow">if</font>( fy &lt;= -s ) {
00050         fy += s2 ;
00051         y -- ;
00052       }
00053       <font class="keywordflow">return</font> <font class="keyword">true</font> ;
00054     }
00055   }
00056 
00057   <font class="comment">// move to the head of next scan line</font>
00058 
00059   <font class="keywordtype">bool</font> nextLine()<font class="keyword"> </font>{
00060     i = 0 ;
00061     <font class="keywordflow">if</font>( ++j &gt;= v ) {
00062       j = 0 ;
00063       x = rx = x0 ;
00064       y = ry = y0 ;
00065       fx = fy = frx = fry = 0 ;
00066       <font class="keywordflow">return</font> <font class="keyword">false</font> ;
00067     }<font class="keywordflow">else</font> {
00068       rx += dxv ;
00069       frx += fdxv ;
00070       <font class="keywordflow">if</font>( frx &gt; s ) {
00071      frx -= s2 ;
00072      rx ++ ;
00073       }<font class="keywordflow">else</font> <font class="keywordflow">if</font>( frx &lt;= -s ) {
00074      frx += s2 ;
00075      rx -- ;
00076       }
00077       ry += dyv ;
00078       fry += fdyv ;
00079       <font class="keywordflow">if</font>( fry &gt; s ) {
00080      fry -= s2 ;
00081      ry ++ ;
00082       }<font class="keywordflow">else</font> <font class="keywordflow">if</font>( fry &lt;= -s ) {
00083      fry += s2 ;
00084      ry -- ;
00085       }
00086       x = rx ;
00087       y = ry ;
00088       fx = frx ;
00089       fy = fry ;
00090       <font class="keywordflow">return</font> <font class="keyword">true</font> ;
00091     }
00092   }
00093 
00094   <font class="keywordtype">int</font> nearestX()<font class="keyword"> const </font>{ <font class="keywordflow">return</font> x ; }
00095   <font class="keywordtype">int</font> nearestY()<font class="keyword"> const </font>{ <font class="keywordflow">return</font> y ; }
00096 
00097   <font class="comment">// p1 and p2 are integers that reprensent the relative weight of two</font>
00098   <font class="comment">// coordinates given. the real x coordinate is (x1*p1+x2*p2)/(p1+p2)</font>
00099 
00100   <font class="keywordtype">void</font> nearX( <font class="keywordtype">int</font>&amp; x1, <font class="keywordtype">int</font>&amp; p1, <font class="keywordtype">int</font>&amp; x2, <font class="keywordtype">int</font>&amp; p2 )<font class="keyword"> const </font>{
00101     <font class="keywordflow">if</font>( fx &gt;= 0 ) {
00102       x1 = x ;
00103       p1 = s2 - fx ;
00104       x2 = x + 1 ;
00105       p2 = fx ;
00106     }<font class="keywordflow">else</font> {
00107       x1 = x - 1 ;
00108       p1 = s2 + fx ;
00109       x2 = x ;
00110       p2 = - fx ;
00111     }
00112   }
00113   <font class="keywordtype">void</font> nearY( <font class="keywordtype">int</font>&amp; y1, <font class="keywordtype">int</font>&amp; p1, <font class="keywordtype">int</font>&amp; y2, <font class="keywordtype">int</font>&amp; p2 )<font class="keyword"> const </font>{
00114     <font class="keywordflow">if</font>( fy &gt;= 0 ) {
00115       y1 = y ;
00116       p1 = s2 - fy ;
00117       y2 = y + 1 ;
00118       p2 = fy ;
00119     }<font class="keywordflow">else</font> {
00120       y1 = y - 1 ;
00121       p1 = s2 + fy ;
00122       y2 = y ;
00123       p2 = - fy ;
00124     }
00125   }
00126 };
00127 
00128 <font class="preprocessor"># include &lt;XVImageBase.h&gt;</font>
00129 <font class="preprocessor"># include &lt;string.h&gt;</font>
00130 
00131 <font class="comment">/*
</font>00132 <font class="comment"> Transform parallelogram abcd on source image to the whole target image.
</font>00133 <font class="comment"> a -&gt; (0,0)
</font>00134 <font class="comment"> b -&gt; (w,0)
</font>00135 <font class="comment"> c -&gt; (w,h)
</font>00136 <font class="comment"> d -&gt; (0,h)
</font>00137 <font class="comment">*/</font>
00138 
00139 <font class="keyword">template</font>&lt;<font class="keyword">class </font>T&gt;
00140 <font class="keywordtype">void</font> intAffineWarp( <font class="keyword">const</font> <a class="code" href="class_XVImageBase.html">XVImageBase</a>&lt;T&gt;&amp; source, <a class="code" href="class_XVImageBase.html">XVImageBase</a>&lt;T&gt;&amp; target,
00141               XVPosition a, XVPosition b, XVPosition d )<font class="keyword"> </font>{
00142   <font class="keywordflow">if</font>( target.Width() == 0 || target.Height() == 0 ) {
00143     <font class="keywordflow">return</font> ;
00144   }
00145   T zero ;
00146   memset( &amp;zero, 0, <font class="keyword">sizeof</font>(zero) );
00147   XVRectRaster r( a.PosX(), a.PosY(), b.PosX(), b.PosY(), d.PosX(), d.PosY(),
00148             target.Width(), target.Height() );
00149   XVImageWIterator&lt;T&gt; p(target);
00150   <font class="keywordtype">int</font> w = source.Width(), h = source.Height() ;
00151   <font class="keywordtype">int</font> x, y;
00152   XVPosition c = b - a + d ;
00153   <font class="keywordflow">if</font>( source.contains(a) &amp;&amp; source.contains(b) &amp;&amp;
00154       source.contains(c) &amp;&amp; source.contains(d)) {
00155     <font class="keywordflow">do</font> {
00156       *p = source[ r.nearestY() ][ r.nearestX() ];
00157       ++ p ;
00158     }<font class="keywordflow">while</font>( r.next() );
00159   }<font class="keywordflow">else</font> {
00160     <font class="keywordflow">do</font> {
00161       x = r.nearestX() ;
00162       y = r.nearestY() ;
00163       <font class="keywordflow">if</font>( x &gt;= 0 &amp;&amp; x &lt; w &amp;&amp; y &gt;= 0 &amp;&amp; y &lt; h ) {
00164      *p = source[y][x] ;
00165       }<font class="keywordflow">else</font> {
00166      *p = zero ;
00167       }
00168       ++ p ;
00169     }<font class="keywordflow">while</font>( r.next() );
00170   }
00171 };
00172 
00173 <font class="comment">/*
</font>00174 <font class="comment"> center is the point on the source image which will be the center 
</font>00175 <font class="comment"> of the target image. 
</font>00176 <font class="comment"> theta is counter-clockwise from source to target.
</font>00177 <font class="comment"> scale is source to target
</font>00178 <font class="comment"> sheer is positive for left-sheer, negative for right-sheer
</font>00179 <font class="comment">*/</font>
00180 
00181 <font class="keyword">template</font>&lt;<font class="keyword">class </font>T&gt;
00182 <font class="keywordtype">void</font> intAffineWarp( <font class="keyword">const</font> <a class="code" href="class_XVImageBase.html">XVImageBase</a>&lt;T&gt;&amp; source, <a class="code" href="class_XVImageBase.html">XVImageBase</a>&lt;T&gt;&amp; target,
00183               XVPosition center, <font class="keywordtype">double</font> theta = 0.0,
00184               <font class="keywordtype">double</font> scaleX = 1.0, <font class="keywordtype">double</font> scaleY = 1.0,
00185               <font class="keywordtype">double</font> sheer = 0.0 )<font class="keyword"> </font>{
00186   <font class="keywordtype">double</font> cx = center.PosX() ;
00187   <font class="keywordtype">double</font> cy = center.PosY() ;
00188   <font class="keywordtype">double</font> w = target.Width() / scaleX / 2.0 ;
00189   <font class="keywordtype">double</font> h = target.Height() / scaleY / 2.0 ;
00190   <font class="keywordtype">double</font> cos_theta = cos( theta );
00191   <font class="keywordtype">double</font> sin_theta = sin( theta );
00192   <font class="keywordtype">double</font> wc = w * cos_theta ;
00193   <font class="keywordtype">double</font> ws = w * sin_theta ;
00194   <font class="keywordtype">double</font> hc = h * cos_theta ;
00195   <font class="keywordtype">double</font> hs = h * sin_theta ;
00196   <font class="keywordtype">double</font> wss = ws * sheer ;
00197   <font class="keywordtype">double</font> hcs = hc * sheer ;
00198   <font class="keywordtype">int</font> ax = (<font class="keywordtype">int</font>) round( cx - wc + hs + wss + hcs);
00199   <font class="keywordtype">int</font> ay = (<font class="keywordtype">int</font>) round( cy - ws - hc );
00200   <font class="keywordtype">int</font> bx = (<font class="keywordtype">int</font>) round( cx + wc + hs - wss + hcs );
00201   <font class="keywordtype">int</font> by = (<font class="keywordtype">int</font>) round( cy + ws - hc );
00202   <font class="keywordtype">int</font> dx = (<font class="keywordtype">int</font>) round( cx - wc - hs + wss - hcs );
00203   <font class="keywordtype">int</font> dy = (<font class="keywordtype">int</font>) round( cy - ws + hc );
00204   intAffineWarp( source, target, XVPosition( ax, ay ),
00205            XVPosition( bx, by ), XVPosition( dx, dy ) );
00206 }
00207 
00208 <font class="preprocessor"># endif // _XVRECTRASTER_H_
</font>00209 <font class="preprocessor"></font>
</div></pre><hr><address><small>Generated at Fri Oct 26 00:17:16 2007 for XVision by
<a href="http://www.stack.nl/~dimitri/doxygen/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.0 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2000</small></address>
</body>
</html>
