<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta name="robots" content="noindex">
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>/home/burschka/XVision2-2.0.0/src/Devices/svsclass.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.0 on Fri Oct 26 00:17:16 2007 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; </center>
<hr><h1>/home/burschka/XVision2-2.0.0/src/Devices/svsclass.h</h1><div class="fragment"><pre>00001  <font class="comment">//#########################################</font>
00002  <font class="comment">// svsclass.h </font>
00003  <font class="comment">//</font>
00004  <font class="comment">// class definitions for the SVS system</font>
00005  <font class="comment">//</font>
00006  <font class="comment">//#########################################</font>
00007  <font class="comment">//</font>
00008 
00009  <font class="comment">//</font>
00010  <font class="comment">// svsclass.h</font>
00011  <font class="comment">//</font>
00012  <font class="comment">// Copyright 2001 by Kurt Konolige</font>
00013  <font class="comment">//</font>
00014  <font class="comment">// The author hereby grants to SRI permission to use this software.</font>
00015  <font class="comment">// The author also grants to SRI permission to distribute this software</font>
00016  <font class="comment">// to educational institutes for non-commercial educational use only.</font>
00017  <font class="comment">//</font>
00018  <font class="comment">// The author hereby grants to other individuals or organizations</font>
00019  <font class="comment">// permission to use this software for non-commercial</font>
00020  <font class="comment">// educational use only.  This software may not be distributed to others</font>
00021  <font class="comment">// except by SRI, under the conditions above.</font>
00022  <font class="comment">//</font>
00023  <font class="comment">// Other than these cases, no part of this software may be used or</font>
00024  <font class="comment">// distributed without written permission of the author.</font>
00025  <font class="comment">//</font>
00026  <font class="comment">// Neither the author nor SRI make any representations about the </font>
00027  <font class="comment">// suitability of this software for any purpose.  It is provided </font>
00028  <font class="comment">// "as is" without express or implied warranty.</font>
00029  <font class="comment">//</font>
00030  <font class="comment">// Kurt Konolige</font>
00031  <font class="comment">// Senior Computer Scientist</font>
00032  <font class="comment">// SRI International</font>
00033  <font class="comment">// 333 Ravenswood Avenue</font>
00034  <font class="comment">// Menlo Park, CA 94025</font>
00035  <font class="comment">// E-mail:  konolige@ai.sri.com</font>
00036  <font class="comment">//</font>
00037  <font class="comment">//</font>
00038 
00039 
00040 <font class="preprocessor">#ifndef svsclass_h
</font>00041 <font class="preprocessor"></font><font class="preprocessor">#define svsclass_h
</font>00042 <font class="preprocessor"></font>
00043 <font class="preprocessor">#include "svs.h"</font>
00044 
00045 
00046 <font class="comment">//</font>
00047 <font class="comment">// Class svsImageParams</font>
00048 <font class="comment">//</font>
00049 <font class="comment">// Has basic information about the format of an image</font>
00050 <font class="comment">//</font>
00051 
00052 <font class="keyword">class </font>svsImageParams
00053 {
00054 <font class="keyword">public</font>:
00055   <font class="comment">// image basic full-frame parameters</font>
00056   <font class="keywordtype">int</font> linelen;           <font class="comment">// Image line length, in pixels </font>
00057   <font class="keywordtype">int</font> lines;                    <font class="comment">// Number of image lines </font>
00058 
00059   <font class="comment">// image subwindow</font>
00060   <font class="keywordtype">int</font> ix;           <font class="comment">// Subimage start column </font>
00061   <font class="keywordtype">int</font> iy;           <font class="comment">// Subimage start row </font>
00062   <font class="keywordtype">int</font> width;             <font class="comment">// Subimage width, in pixels </font>
00063   <font class="keywordtype">int</font> height;            <font class="comment">// Subimage height, in pixels </font>
00064   <font class="keywordtype">int</font> vergence;               <font class="comment">// Subimage vergence between images</font>
00065 
00066   <font class="comment">// display</font>
00067   <font class="keywordtype">double</font> gamma;               <font class="comment">// gamma correction for display, 1.0 is none </font>
00068 };
00069 
00070 
00071 <font class="comment">//</font>
00072 <font class="comment">// Class svsIntrinsicParams</font>
00073 <font class="comment">//</font>
00074 <font class="comment">// Internal camera rectification parameters for an image</font>
00075 <font class="comment">//</font>
00076 <font class="comment">// This structure stores the intrinsic parameters of a camera:</font>
00077 <font class="comment">//   Lens distortion, decentering, and projection matrix</font>
00078 <font class="comment">//</font>
00079 <font class="comment">//</font>
00080 
00081 <font class="keyword">class </font>svsIntrinsicParams
00082 {
00083 <font class="keyword">public</font>:
00084   <font class="comment">// Intrinsic parameters </font>
00085   <font class="keywordtype">int</font>       pwidth;      <font class="comment">// [pix]    Width of frame grabber's image </font>
00086   <font class="keywordtype">int</font>       pheight;     <font class="comment">// [pix]    Height of frame grabber's image </font>
00087   <font class="keywordtype">double</font>    dpx;    <font class="comment">// [mm/pix] X dimension of pixel in frame grabber </font>
00088   <font class="keywordtype">double</font>    dpy;    <font class="comment">// [mm/pix] Y dimension of pixel in frame grabber </font>
00089   <font class="keywordtype">double</font>    sx;          <font class="comment">// []       Scale factor to compensate for any error in dpx   </font>
00090   <font class="keywordtype">double</font>    Cx;          <font class="comment">// [pix]    Z axis intercept of image plane </font>
00091   <font class="keywordtype">double</font>    Cy;     <font class="comment">// [pix]    Z axis intercept of image plane </font>
00092   <font class="keywordtype">double</font>    f;      <font class="comment">// [mm]     Focal length </font>
00093   <font class="keywordtype">double</font>    kappa1;      <font class="comment">// [1/mm^2] First coefficient of radial distortion </font>
00094   <font class="keywordtype">double</font>    kappa2;      <font class="comment">// [1/mm^4] Second coefficient of radial distortion </font>
00095   <font class="keywordtype">float</font>     proj[3][4]; <font class="comment">// projection matrix of rectified image </font>
00096   <font class="keywordtype">float</font>     rect[3][3]; <font class="comment">// rectification transform after correction for lens distortion </font>
00097 };
00098 
00099 
00100 <font class="comment">//</font>
00101 <font class="comment">// Class svsRectParams</font>
00102 <font class="comment">//</font>
00103 <font class="comment">// Rectification parameters for an image</font>
00104 <font class="comment">//</font>
00105 <font class="comment">// This class holds internal and external parameters for rectification of </font>
00106 <font class="comment">//   a stereo image pair.  It also holds ptr buffers for fast warping.</font>
00107 <font class="comment">//</font>
00108 
00109 <font class="keyword">class </font>svsRectParams
00110 {
00111 <font class="keyword">public</font>:
00112   svsIntrinsicParams left;
00113   svsIntrinsicParams right;
00114 
00115   <font class="comment">// Transformation between left and right cameras </font>
00116   <font class="comment">// Coordinate system is attached to the center of projection of the</font>
00117   <font class="comment">//   left camera, with the X and Y axis aligned with the u and v axis,</font>
00118   <font class="comment">//   and Z along the line of sight </font>
00119   <font class="keywordtype">double</font> Tx;             <font class="comment">// [mm] </font>
00120   <font class="keywordtype">double</font> Ty;             <font class="comment">// [mm] </font>
00121   <font class="keywordtype">double</font> Tz;             <font class="comment">// [mm] </font>
00122   <font class="keywordtype">double</font> Rx;             <font class="comment">// [rad] Yaw </font>
00123   <font class="keywordtype">double</font> Ry;             <font class="comment">// [rad] Pitch </font>
00124   <font class="keywordtype">double</font> Rz;             <font class="comment">// [rad] Roll </font>
00125 };
00126 
00127 
00128 <font class="comment">//</font>
00129 <font class="comment">// Class svsDisparityParams</font>
00130 <font class="comment">//</font>
00131 <font class="comment">// Disparity processing parameters for an image</font>
00132 <font class="comment">//</font>
00133 <font class="comment">// This class holds disparity processing parameters for a stereo image:</font>
00134 <font class="comment">//    number of disparities, subpixel interpolation, etc.</font>
00135 <font class="comment">//</font>
00136 
00137 <font class="keyword">class </font>svsDisparityParams
00138 {
00139 <font class="keyword">public</font>:
00140   <font class="keywordtype">int</font> corrsize;               <font class="comment">// Correlation window size, pixels </font>
00141   <font class="keywordtype">int</font> thresh;            <font class="comment">// Confidence threshold, 0-20 </font>
00142   <font class="keywordtype">bool</font> lr;               <font class="comment">// Left/right check, 1=on, 0=off </font>
00143   <font class="keywordtype">int</font> ndisp;             <font class="comment">// Number of pixel disparities to search </font>
00144   <font class="keywordtype">int</font> dpp;                      <font class="comment">// Disparities per pixel </font>
00145   <font class="keywordtype">int</font> offx, offy;               <font class="comment">// Horopter offset; offy isn't used...</font>
00146 
00147   <font class="comment">// disparity buffer offsets</font>
00148   <font class="keywordtype">int</font> dleft, dtop;       <font class="comment">// offset of disparity image upper left corner</font>
00149   <font class="keywordtype">int</font> dwidth, dheight;        <font class="comment">// disparity image actual width and height</font>
00150 
00151   <font class="comment">// temps</font>
00152   <font class="keywordtype">int</font> xx, yy;
00153 };
00154 
00155 
00156 <font class="comment">//</font>
00157 <font class="comment">// Class svsStereoImage</font>
00158 <font class="comment">//</font>
00159 <font class="comment">// Base class for all stereo acquisition and processing</font>
00160 <font class="comment">// Contains left, right, and left color (optional) images </font>
00161 <font class="comment">// Contains disparity and 3D point images</font>
00162 <font class="comment">// Parameters of the images, especially relating to image</font>
00163 <font class="comment">//   frame size and subwindowing</font>
00164 <font class="comment">//</font>
00165 
00166 <font class="keyword">class </font>svsStereoProcess;
00167 
00168 <font class="keyword">class </font>svsStereoImage
00169 {
00170   <font class="keyword">friend</font> <font class="keyword">class </font>svsStereoProcess;
00171   <font class="keyword">friend</font> <font class="keyword">class </font>svsAcquireImages;
00172  <font class="keyword">public</font>:
00173   <font class="comment">// image arrays; color image is always RGBX</font>
00174   <font class="keywordtype">unsigned</font> <font class="keywordtype">char</font> *left, *right, *color, *color_right;
00175   <font class="keywordtype">int</font> imageBufsize;      <font class="comment">// size of buffers, in pixels</font>
00176   <font class="keywordtype">bool</font> haveColor;        <font class="comment">// true if color array present</font>
00177   <font class="keywordtype">bool</font> haveColorRight;        <font class="comment">// true if right image color array present</font>
00178   <font class="keywordtype">bool</font> haveImages;       <font class="comment">// true if we have good stereo images</font>
00179 
00180   <font class="comment">// error explanation</font>
00181 
00182   <font class="comment">// image format, particular to each object</font>
00183   svsImageParams ip;
00184 
00185   <font class="comment">// rectification parameters for left and right images</font>
00186   <font class="keywordtype">bool</font> isRectified;      <font class="comment">// have we done the rectification already?</font>
00187   <font class="keywordtype">bool</font> haveRect;         <font class="comment">// true if the rectification params exist</font>
00188   svsRectParams rp;      <font class="comment">// rectification params, if they exist</font>
00189 
00190   <font class="comment">// disparity array</font>
00191   <font class="keywordtype">short</font> *disparity;      <font class="comment">// disparity image, 16-bit pixels</font>
00192   <font class="keywordtype">bool</font> haveDisparity;         <font class="comment">// have we calculated the disparity yet?</font>
00193   svsDisparityParams dp; <font class="comment">// disparity image parameters</font>
00194 
00195   <font class="comment">// 3D array</font>
00196   <font class="comment">// Format: same size as image, 3 arrays of floats: X,Y,Z</font>
00197   <font class="comment">// Z value is &lt; 0 for no disparity value</font>
00198   <font class="keywordtype">float</font> *X, *Y, *Z;
00199   <font class="keywordtype">bool</font> have3D;
00200   <font class="keywordtype">int</font> numPoints;         <font class="comment">// number of points actually found</font>
00201 
00202 
00203   <font class="comment">// Member functions for handling buffers</font>
00204 
00205   IMPORT svsStereoImage();    <font class="comment">// sets it up, no buffers</font>
00206   IMPORT ~svsStereoImage();   <font class="comment">// tears it down, frees buffers if owned</font>
00207 
00208   <font class="keywordtype">void</font> Error(<font class="keywordtype">char</font> *s)         <font class="comment">// sets an error string  </font>
00209      { strcpy(error, s); }
00210   <font class="keywordtype">char</font> *Error()               <font class="comment">// returns the error string</font>
00211      { <font class="keywordflow">return</font> error; }
00212 
00213   <font class="comment">// Puts a set of images into the image buffers</font>
00214   IMPORT <font class="keywordtype">void</font> SetImages(<font class="keywordtype">unsigned</font> <font class="keywordtype">char</font> *lim, <font class="keywordtype">unsigned</font> <font class="keywordtype">char</font> *rim, <font class="keywordtype">unsigned</font> <font class="keywordtype">char</font> *cim,
00215               <font class="keywordtype">unsigned</font> <font class="keywordtype">char</font> *cimr = NULL,
00216                svsImageParams *ip = NULL, svsRectParams *rp = NULL, 
00217                <font class="keywordtype">bool</font> rect = <font class="keyword">false</font>, <font class="keywordtype">bool</font> copy = <font class="keyword">false</font>);
00218   IMPORT <font class="keywordtype">void</font> CopyImages(<font class="keywordtype">unsigned</font> <font class="keywordtype">char</font> *lim, <font class="keywordtype">unsigned</font> <font class="keywordtype">char</font> *rim, <font class="keywordtype">unsigned</font> <font class="keywordtype">char</font> *cim,
00219               <font class="keywordtype">unsigned</font> <font class="keywordtype">char</font> *cimr = NULL,
00220             svsImageParams *ip = NULL, svsRectParams *rp = NULL, <font class="keywordtype">bool</font> rect = <font class="keyword">false</font>);
00221 
00222   <font class="comment">// File input/output</font>
00223   IMPORT <font class="keywordtype">bool</font> SaveToFile(<font class="keywordtype">char</font> *basename);   <font class="comment">// saves images and params to files</font>
00224   IMPORT <font class="keywordtype">bool</font> ReadFromFile(<font class="keywordtype">char</font> *basename); <font class="comment">// gets images and params from files</font>
00225   IMPORT <font class="keywordtype">bool</font> ReadParams(<font class="keywordtype">char</font> *name);       <font class="comment">// reads just params from file</font>
00226   IMPORT <font class="keywordtype">bool</font> SaveParams(<font class="keywordtype">char</font> *name);       <font class="comment">// save just params to file</font>
00227   IMPORT <font class="keywordtype">void</font> SetRectParams(svsSP *sp);     <font class="comment">// sets rectification params from sp</font>
00228   IMPORT <font class="keywordtype">bool</font> SaveDisparity(<font class="keywordtype">char</font> *name, <font class="keywordtype">bool</font> bmp = <font class="keyword">false</font>);  <font class="comment">// save a disparity image </font>
00229   IMPORT <font class="keywordtype">bool</font> Save3DPointCloud(<font class="keywordtype">char</font> *name); <font class="comment">// save a point cloud of 3D points</font>
00230   IMPORT <font class="keywordtype">bool</font> Save3DPointArray(<font class="keywordtype">char</font> *name); <font class="comment">// save a point array of 3D points</font>
00231 
00232   <font class="comment">// allocates and releases space for buffers</font>
00233   IMPORT <font class="keywordtype">void</font> AllocateImages(); 
00234   IMPORT <font class="keywordtype">void</font> ReleaseImages(); 
00235   IMPORT <font class="keywordtype">void</font> AllocateDisparity(); 
00236   IMPORT <font class="keywordtype">void</font> ReleaseDisparity(); 
00237   IMPORT <font class="keywordtype">void</font> Allocate3d(); 
00238   IMPORT <font class="keywordtype">void</font> Release3d(); 
00239 
00240   <font class="comment">// Copying</font>
00241   IMPORT <font class="keywordtype">void</font> CopyFrom(svsStereoImage *si, <font class="keywordtype">int</font> reduce = 0);  <font class="comment">// copies contents of si,</font>
00242                     <font class="comment">// optionally reducing the image</font>
00243 
00244   <font class="comment">// transfer image params</font>
00245   IMPORT svsSP *GetSP(); <font class="comment">// return it</font>
00246   svsSP sp;              <font class="comment">// legacy, but useful</font>
00247 
00248   IMPORT <font class="keywordtype">void</font> ImageToSP();
00249   IMPORT <font class="keywordtype">void</font> SPToImage();
00250 
00251   <font class="comment">// transfer rectification params</font>
00252   IMPORT <font class="keywordtype">void</font> RectToSP();
00253   IMPORT <font class="keywordtype">void</font> SPToRect();
00254 
00255   <font class="comment">// transfer disparity params</font>
00256   IMPORT <font class="keywordtype">void</font> DispToSP();
00257   IMPORT <font class="keywordtype">void</font> SPToDisp();
00258 
00259 
00260 <font class="keyword">protected</font>:
00261   <font class="comment">// these are the real buffers, if we allocate them ourselves</font>
00262   <font class="keywordtype">unsigned</font> <font class="keywordtype">char</font> *left_buf, *right_buf, *color_buf, *color_right_buf;
00263   <font class="keywordtype">short</font> *disparity_buf;
00264   <font class="keywordtype">void</font> reduceByTwo(<font class="keywordtype">unsigned</font> <font class="keywordtype">char</font> *output, <font class="keywordtype">unsigned</font> <font class="keywordtype">char</font> *input);
00265 
00266   <font class="comment">// error buffer</font>
00267   <font class="keywordtype">char</font> error[256];       
00268 
00269 };
00270 
00271 
00272 
00273 
00274 <font class="comment">//</font>
00275 <font class="comment">// Class svsStereoProcess</font>
00276 <font class="comment">//</font>
00277 <font class="comment">// Process class for computing disparity image, and 3D points</font>
00278 <font class="comment">//</font>
00279 
00280 <font class="keyword">class </font>svsStereoProcess
00281 {
00282  <font class="keyword">public</font>:
00283   <font class="comment">// Construct and Destruct</font>
00284   IMPORT svsStereoProcess();  <font class="comment">// sets it up</font>
00285   IMPORT ~svsStereoProcess(); <font class="comment">// tears it down</font>
00286 
00287   <font class="comment">// Calculations</font>
00288   IMPORT <font class="keywordtype">bool</font> CalcStereo(svsStereoImage *si); <font class="comment">// Calculate the stereo disparity image; </font>
00289                     <font class="comment">// make it overrideable</font>
00290   IMPORT <font class="keywordtype">bool</font> Calc3D(svsStereoImage *si); <font class="comment">// Calculate the 3D values</font>
00291   IMPORT <font class="keywordtype">bool</font> CalcPoint3D(<font class="keywordtype">int</font> x, <font class="keywordtype">int</font> y, svsStereoImage *si,
00292                     <font class="keywordtype">double</font> *X, <font class="keywordtype">double</font> *Y, <font class="keywordtype">double</font> *Z);
00293 
00294 <font class="keyword">private</font>:
00295     <font class="keywordtype">void</font> *calcBuf;
00296 };
00297 
00298 
00299 <font class="comment">//</font>
00300 <font class="comment">// Multiscale class</font>
00301 <font class="comment">// Subclasses the stereo calculation object</font>
00302 <font class="comment">// Adds its own processing for a small image</font>
00303 <font class="comment">//</font>
00304 
00305 <font class="keyword">class </font>svsMultiProcess : <font class="keyword">public</font> svsStereoProcess
00306 {
00307 <font class="keyword">public</font>:
00308   IMPORT svsMultiProcess();
00309   IMPORT ~svsMultiProcess();
00310   
00311   <font class="comment">// multiscale calculations</font>
00312   IMPORT <font class="keywordtype">bool</font> CalcStereo(svsStereoImage *si); <font class="comment">// Overrides the svsStereoProcess fn</font>
00313   IMPORT <font class="keywordtype">void</font> fillIn(svsStereoImage *original, svsStereoImage *reduced);
00314   <font class="keywordtype">bool</font> doIt;        <font class="comment">// true if we're doing the multiproc thang</font>
00315 
00316 <font class="keyword">private</font>:
00317   svsStereoImage *reducedImage;    <font class="comment">// reduced stereo image</font>
00318   svsStereoProcess *reducedProc; <font class="comment">// reduced stereo processing</font>
00319 };
00320 
00321 
00322 <font class="comment">//</font>
00323 <font class="comment">// Class svsWarpProcess</font>
00324 <font class="comment">//</font>
00325 <font class="comment">// Process class for computing warp</font>
00326 <font class="comment">// Used internally, shouldn't be invoked by applications</font>
00327 <font class="comment">//</font>
00328 
00329 <font class="keyword">class </font>svsWarpProcess
00330 {
00331  <font class="keyword">public</font>:
00332   <font class="comment">// Construct and Destruct</font>
00333   svsWarpProcess();      <font class="comment">// sets it up</font>
00334   ~svsWarpProcess();          <font class="comment">// tears it down</font>
00335 
00336   <font class="comment">// Calculate the warp transform</font>
00337   <font class="keywordtype">void</font> Warp(<font class="keywordtype">unsigned</font> <font class="keywordtype">char</font> *dest, <font class="keywordtype">unsigned</font> <font class="keywordtype">char</font> *src, <font class="keywordtype">int</font> which, svsSP *sp); 
00338 
00339   <font class="comment">// Buffer allocation</font>
00340   <font class="keywordtype">void</font> AllocateBuffers(<font class="keywordtype">int</font> w, <font class="keywordtype">int</font> h);
00341   <font class="keywordtype">void</font> ReleaseBuffers();
00342 
00343 <font class="keyword">private</font>:
00344   <font class="comment">// Data buffers for warp addressing</font>
00345   ADDRTYPE *laddr_buf, *laddr;
00346   ADDRTYPE *raddr_buf, *raddr;
00347   <font class="keywordtype">unsigned</font> <font class="keywordtype">short</font> *ibuf_buf, *ibuf;
00348   <font class="keywordtype">int</font> l_max_y[MAXY], r_max_y[MAXY];
00349 
00350   <font class="comment">// subwindow warping</font>
00351   <font class="keyword">struct </font>subwin_index l_swi[MAXX], r_swi[MAXX];
00352 
00353   <font class="comment">// how things have changed</font>
00354   <font class="keywordtype">double</font> checksum;
00355   <font class="keywordtype">int</font> oldix, oldiy, oldvergence, oldwidth;
00356   <font class="keywordtype">int</font> oldw, oldh;
00357   <font class="keywordtype">double</font> get_checksum(svsSP *sp);
00358 };
00359 
00360 
00361 <font class="comment">//</font>
00362 <font class="comment">// Image Acquisition Classes</font>
00363 <font class="comment">// -- from stereo head, files, and memory</font>
00364 <font class="comment">//</font>
00365 
00366 <font class="comment">//</font>
00367 <font class="comment">// Class svsAcquireImages</font>
00368 <font class="comment">//</font>
00369 <font class="comment">// Subclassed by the individual drivers</font>
00370 <font class="comment">//</font>
00371 
00372 <font class="keyword">class </font>svsAcquireImages
00373 {
00374 <font class="keyword">public</font>:
00375 
00376   <font class="comment">// parameters</font>
00377   IMPORT svsImageParams     *GetIP(); <font class="comment">// returns basic image parameters</font>
00378   IMPORT svsRectParams      *GetRP(); <font class="comment">// returns rectification parameters</font>
00379   IMPORT svsDisparityParams *GetDP(); <font class="comment">// returns stereo disparity parameters</font>
00380 
00381   <font class="comment">// rectification stuff</font>
00382   IMPORT <font class="keywordtype">bool</font> HaveRect();     <font class="comment">// if we have rectification parameters</font>
00383   IMPORT <font class="keywordtype">bool</font> SetRect(<font class="keywordtype">bool</font> on);    <font class="comment">// turns rectification on and off</font>
00384   IMPORT <font class="keywordtype">bool</font> GetRect(); <font class="comment">// is rectification turned on?</font>
00385   IMPORT <font class="keywordtype">bool</font> IsRect();       <font class="comment">// is current buffer rectified?</font>
00386 
00387 
00388   <font class="comment">// construction and destruction</font>
00389   IMPORT svsAcquireImages();
00390   IMPORT <font class="keyword">virtual</font> ~svsAcquireImages();
00391 
00392   <font class="comment">// Device open and close</font>
00393   <font class="keyword">virtual</font> <font class="keywordtype">bool</font> Open(<font class="keywordtype">char</font> *name = NULL) = 0; <font class="comment">// opens a file or device</font>
00394   IMPORT <font class="keyword">virtual</font> <font class="keywordtype">bool</font> Close();          <font class="comment">// closes it</font>
00395 
00396   <font class="comment">// Start/stop acquisition, check parameters</font>
00397   <font class="keyword">virtual</font> <font class="keywordtype">bool</font> Start() = 0;
00398   <font class="keyword">virtual</font> <font class="keywordtype">bool</font> Stop() = 0;
00399   <font class="keyword">virtual</font> <font class="keywordtype">bool</font> CheckParams() = 0;
00400 
00401  <font class="comment">// Acquire images</font>
00402   <font class="keyword">virtual</font> svsStereoImage *GetImage(<font class="keywordtype">int</font> ms) = 0; <font class="comment">// returns a stereo image</font>
00403 
00404   <font class="comment">// Parameter and file I/O</font>
00405   IMPORT <font class="keyword">virtual</font> <font class="keywordtype">bool</font> ReadParams(<font class="keywordtype">char</font> *basename); <font class="comment">// reads params from file</font>
00406   IMPORT <font class="keyword">virtual</font> <font class="keywordtype">bool</font> SaveParams(<font class="keywordtype">char</font> *basename); <font class="comment">// saves params to file</font>
00407   IMPORT <font class="keywordtype">void</font> SetRectParams(svsSP *sp); <font class="comment">// sets rectification params from sp</font>
00408   IMPORT <font class="keyword">virtual</font> <font class="keywordtype">bool</font> SaveToFile(<font class="keywordtype">char</font> *basename);   <font class="comment">// saves images and params to files</font>
00409 
00410   <font class="comment">// Errors</font>
00411   <font class="keywordtype">void</font> Error(<font class="keywordtype">char</font> *s)         <font class="comment">// sets an error string</font>
00412      { strcpy(error, s); }
00413   <font class="keywordtype">char</font> *Error()               <font class="comment">// returns the error string</font>
00414      { <font class="keywordflow">return</font> error; }
00415 
00416 
00417 <font class="keyword">protected</font>:
00418   <font class="comment">// error return</font>
00419   <font class="keywordtype">char</font> error[256];
00420 
00421   <font class="comment">// device</font>
00422   <font class="keywordtype">char</font> *deviceName;
00423   <font class="keywordtype">bool</font> isOpened;
00424 
00425   <font class="comment">// rectification buffers, do it here so we can manage them</font>
00426   <font class="keywordtype">int</font> warpBufsize;
00427   <font class="keywordtype">unsigned</font> <font class="keywordtype">char</font> *left_warp_buf, *right_warp_buf, *color_warp_buf, *color_right_warp_buf;
00428   <font class="keywordtype">unsigned</font> <font class="keywordtype">char</font> *left_warp, *right_warp, *color_warp, *color_right_warp;
00429   <font class="keywordtype">bool</font> AllocateBuffers();
00430   <font class="keywordtype">void</font> ReleaseBuffers();
00431 
00432   <font class="comment">// rectification</font>
00433   svsWarpProcess *warpObj;
00434   <font class="keywordtype">bool</font> doRect;           <font class="comment">// true if we're doing rectification</font>
00435   IMPORT <font class="keywordtype">bool</font> Rectify(); <font class="comment">// does rectification </font>
00436 
00437   <font class="comment">// image buffer</font>
00438   svsStereoImage *imageBuf;   <font class="comment">// single buffer object</font>
00439 
00440   svsSP sp;              <font class="comment">// legacy, but useful</font>
00441 };
00442 
00443 
00444 <font class="comment">//</font>
00445 <font class="comment">// Subclass svsVideoImages</font>
00446 <font class="comment">// Does video capture</font>
00447 <font class="comment">//   Must be subclassed by individual capture interfaces</font>
00448 <font class="comment">//</font>
00449 
00450 <font class="keyword">class </font>svsVideoImages
00451   : <font class="keyword">public</font> svsAcquireImages
00452 {
00453 <font class="keyword">public</font>:
00454   <font class="comment">// acquisition subwindow for warping</font>
00455   <font class="keywordtype">bool</font> subwarp;               <font class="comment">// true if warping subimage</font>
00456   <font class="keywordtype">int</font> left_ix, left_iy;       <font class="comment">// source start column and row </font>
00457   <font class="keywordtype">int</font> left_width, left_height;     <font class="comment">// source width and height </font>
00458   <font class="keywordtype">int</font> right_ix, right_iy;     <font class="comment">// source start column and row </font>
00459   <font class="keywordtype">int</font> right_width, right_height;<font class="comment">// source width and height </font>
00460 
00461   <font class="comment">// acquisition device info</font>
00462   <font class="keywordtype">int</font> max_linelen, max_lines; <font class="comment">// max size of camera image</font>
00463   <font class="keywordtype">int</font> max_decimation;         <font class="comment">// 1, 2 or 4 </font>
00464   <font class="keywordtype">int</font> max_binning;       <font class="comment">// 1 or 2 </font>
00465   <font class="keywordtype">bool</font> subwindow;        <font class="comment">// true for subwindow capability</font>
00466 
00467   <font class="keywordtype">int</font> decimation;        <font class="comment">// current decimation</font>
00468   <font class="keywordtype">int</font> binning;           <font class="comment">// current binning</font>
00469 
00470   <font class="keywordtype">bool</font> has_color;        <font class="comment">// return color or not</font>
00471   <font class="keywordtype">bool</font> has_color_right;       <font class="comment">// color for right imager</font>
00472 
00473   <font class="comment">// digitization capabilities</font>
00474   <font class="keywordtype">bool</font> autogain;         <font class="comment">// true if available </font>
00475   <font class="keywordtype">bool</font> manualgain;       <font class="comment">// true if available </font>
00476   <font class="keywordtype">bool</font> autowhite;        <font class="comment">// true if available </font>
00477   <font class="keywordtype">bool</font> manualwhite;      <font class="comment">// true if available </font>
00478   <font class="keywordtype">bool</font> autobrightness;        <font class="comment">// true if available</font>
00479   <font class="keywordtype">bool</font> manualbrightness; <font class="comment">// true if available</font>
00480   <font class="keywordtype">bool</font> manualsaturation; <font class="comment">// saturation control exists?</font>
00481   <font class="keywordtype">bool</font> manualsharpness;       <font class="comment">// sharpness control exists?</font>
00482   <font class="keywordtype">bool</font> manualgamma;      <font class="comment">// imager gamma control exists?</font>
00483 
00484   <font class="comment">// digitization parameters</font>
00485   <font class="keywordtype">bool</font> use_autogain;          <font class="comment">// true if using autogain</font>
00486   <font class="keywordtype">bool</font> use_autowhite;         <font class="comment">// true if using autowhite</font>
00487   <font class="keywordtype">bool</font> use_autobrightness;    <font class="comment">// true if using autobrightness</font>
00488   <font class="keywordtype">int</font> gain;              <font class="comment">// Image gain, from 0 to 100</font>
00489   <font class="keywordtype">int</font> exposure;               <font class="comment">// Image exposure from 0 to 100</font>
00490   <font class="keywordtype">int</font> contrast;               <font class="comment">// Image contrast, from 0 to 100</font>
00491   <font class="keywordtype">int</font> brightness;        <font class="comment">// Image brightness, from 0 to 100</font>
00492   <font class="keywordtype">int</font> saturation;        <font class="comment">// Image color saturation, from 0 to 100 </font>
00493   <font class="keywordtype">int</font> red;               <font class="comment">// Image red gain, from 0 to 100</font>
00494   <font class="keywordtype">int</font> blue;              <font class="comment">// Image green gain, from 0 to 100</font>
00495   <font class="keywordtype">int</font> sharpness;         <font class="comment">// image sharpness</font>
00496 
00497   <font class="comment">//</font>
00498   <font class="comment">// Member functions</font>
00499   <font class="comment">//</font>
00500   
00501   <font class="comment">// construct and destroy</font>
00502   IMPORT svsVideoImages();    <font class="comment">// create object </font>
00503   IMPORT <font class="keyword">virtual</font> ~svsVideoImages(); <font class="comment">// destroy object</font>
00504 
00505   <font class="comment">// enumerate devices</font>
00506   IMPORT <font class="keyword">virtual</font> <font class="keywordtype">int</font> Enumerate(); <font class="comment">// returns count of devices for IEEE 1394 bus</font>
00507   IMPORT <font class="keyword">virtual</font> <font class="keywordtype">char</font> **DeviceIDs(); <font class="comment">// returns list of devices for IEEE 1394 bus </font>
00508 
00509   <font class="comment">// opening a device</font>
00510   IMPORT <font class="keyword">virtual</font> <font class="keywordtype">bool</font> Open(<font class="keywordtype">int</font> device); <font class="comment">// opens a file or device</font>
00511   IMPORT <font class="keyword">virtual</font> <font class="keywordtype">bool</font> Open(<font class="keywordtype">char</font> *name = NULL); <font class="comment">// opens a file or device</font>
00512 
00513   <font class="comment">// Acquisition device calls</font>
00514   <font class="keyword">virtual</font> <font class="keywordtype">bool</font> SetCapture(<font class="keywordtype">int</font> type) = 0; <font class="comment">// CAP_DUAL or CAP_INTERLACE</font>
00515   <font class="keyword">virtual</font> <font class="keywordtype">bool</font> SetFormat(<font class="keywordtype">int</font> type) = 0;  <font class="comment">// MONOCHROME, YUV, or RGB24</font>
00516   <font class="keyword">virtual</font> <font class="keywordtype">bool</font> SetChannel(<font class="keywordtype">int</font> type)= 0;  <font class="comment">// 0, 1, 2 etc, video channel on card</font>
00517   <font class="keyword">virtual</font> <font class="keywordtype">bool</font> SetSwap(<font class="keywordtype">bool</font> on) = 0;        <font class="comment">// Swapping left/right on or off</font>
00518   <font class="keyword">virtual</font> <font class="keywordtype">bool</font> SetColor(<font class="keywordtype">bool</font> on, <font class="keywordtype">bool</font> r = <font class="keyword">false</font>) = 0;    <font class="comment">// Turn on color images</font>
00519 
00520   <font class="comment">// these two must be set before streaming video</font>
00521   <font class="keyword">virtual</font> <font class="keywordtype">bool</font> SetSize(<font class="keywordtype">int</font> w, <font class="keywordtype">int</font> h) = 0; <font class="comment">// size of image</font>
00522   <font class="keyword">virtual</font> <font class="keywordtype">bool</font> SetSample(<font class="keywordtype">int</font> dec, <font class="keywordtype">int</font> bin) = 0;  <font class="comment">// image sampling</font>
00523   <font class="keyword">virtual</font> <font class="keywordtype">bool</font> SetRate(<font class="keywordtype">int</font> rate) = 0;  <font class="comment">// image rate</font>
00524 
00525   <font class="comment">// these can be called during streaming video</font>
00526   <font class="keyword">virtual</font> <font class="keywordtype">bool</font> SetOffset(<font class="keywordtype">int</font> ix, <font class="keywordtype">int</font> iy, <font class="keywordtype">int</font> verge) = 0; <font class="comment">// subwindow origin and vergence</font>
00527   <font class="keyword">virtual</font> <font class="keywordtype">bool</font> SetExposure(<font class="keywordtype">bool</font> <font class="keyword">auto</font>, <font class="keywordtype">int</font> exp, <font class="keywordtype">int</font> gn) = 0;
00528   <font class="keyword">virtual</font> <font class="keywordtype">bool</font> SetBalance(<font class="keywordtype">bool</font> <font class="keyword">auto</font>, <font class="keywordtype">int</font> rd, <font class="keywordtype">int</font> bl) = 0;
00529   <font class="keyword">virtual</font> <font class="keywordtype">bool</font> SetLevel(<font class="keywordtype">int</font> contr, <font class="keywordtype">int</font> bright) = 0;
00530 
00531   <font class="comment">// Set up digitization params, subwindow</font>
00532   <font class="comment">// Set values, then call these fns; can happen during streaming</font>
00533   <font class="keyword">virtual</font> <font class="keywordtype">void</font> SetOffsets() = 0;
00534   <font class="keyword">virtual</font> <font class="keywordtype">void</font> SetDigitization() = 0;
00535 
00536   <font class="comment">// read and write files</font>
00537   IMPORT <font class="keyword">virtual</font> <font class="keywordtype">bool</font> ReadParams(<font class="keywordtype">char</font> *basename); <font class="comment">// reads params from file</font>
00538   IMPORT <font class="keyword">virtual</font> <font class="keywordtype">bool</font> SaveParams(<font class="keywordtype">char</font> *basename); <font class="comment">// saves params to file</font>
00539   IMPORT <font class="keyword">virtual</font> <font class="keywordtype">bool</font> SaveToFile(<font class="keywordtype">char</font> *basename);   <font class="comment">// saves images and params to files</font>
00540 
00541  <font class="keyword">protected</font>:
00542   IMPORT <font class="keywordtype">void</font> ParamsToSP(svsSP &amp;xsp);
00543   IMPORT <font class="keywordtype">void</font> SPToParams(svsSP &amp;xsp);
00544   <font class="keywordtype">void</font> ParamsToSP()<font class="keyword"> </font>{ ParamsToSP(sp); }
00545   <font class="keywordtype">void</font> SPToParams()<font class="keyword"> </font>{ SPToParams(sp); }
00546 
00547 };  
00548 
00549 <font class="comment">//</font>
00550 <font class="comment">// Capture interface library function for returning a subclass object</font>
00551 <font class="comment">//</font>
00552 
00553 IMPORT svsVideoImages *getVideoObject();
00554 
00555 
00556 <font class="comment">//</font>
00557 <font class="comment">// Class svsFileImages</font>
00558 <font class="comment">// File Acquisition Class</font>
00559 <font class="comment">//</font>
00560 
00561 <font class="keyword">class </font>svsFileImages
00562   : <font class="keyword">public</font> svsAcquireImages
00563 {
00564 <font class="keyword">public</font>:
00565   <font class="comment">// Device open and close</font>
00566   IMPORT <font class="keywordtype">bool</font> Open(<font class="keywordtype">char</font> *name); <font class="comment">// opens a file</font>
00567 
00568   <font class="comment">// Start/stop acquisition, check parameters</font>
00569   IMPORT <font class="keywordtype">bool</font> Start();
00570   IMPORT <font class="keywordtype">bool</font> Stop();
00571   IMPORT <font class="keywordtype">bool</font> CheckParams();
00572 
00573   <font class="comment">// Acquire images</font>
00574   IMPORT svsStereoImage *GetImage(<font class="keywordtype">int</font> ms); <font class="comment">// returns a stereo image</font>
00575 
00576   <font class="comment">// File input/output</font>
00577   IMPORT <font class="keywordtype">bool</font> ReadFromFile(<font class="keywordtype">char</font> *basename); <font class="comment">// gets images and params from files</font>
00578   IMPORT <font class="keywordtype">char</font> *Name();                 <font class="comment">// returns current file name</font>
00579 
00580   <font class="comment">// File name</font>
00581   <font class="keywordtype">char</font> name[256];        <font class="comment">// current file name</font>
00582   <font class="keywordtype">char</font> bname[256];       <font class="comment">// base file name</font>
00583   <font class="keywordtype">bool</font> incrName();
00584   <font class="keywordtype">bool</font> first;
00585 };
00586 
00587 
00588 <font class="comment">//</font>
00589 <font class="comment">// Class svsStoredImages</font>
00590 <font class="comment">// Memory Acquisition Class</font>
00591 <font class="comment">// Does not modify stored images</font>
00592 <font class="comment">// Output images are in buffers managed by the class, if rectified</font>
00593 <font class="comment">//</font>
00594 
00595 <font class="keyword">class </font>svsStoredImages
00596   : <font class="keyword">public</font> svsAcquireImages
00597 {
00598 <font class="keyword">public</font>:
00599   <font class="comment">// These functions are noops, always return true</font>
00600   IMPORT <font class="keywordtype">bool</font> Open(<font class="keywordtype">char</font> *name);
00601   IMPORT <font class="keywordtype">bool</font> Start();
00602   IMPORT <font class="keywordtype">bool</font> Stop();
00603   IMPORT <font class="keywordtype">bool</font> CheckParams();
00604 
00605   <font class="comment">// Set up images</font>
00606   IMPORT <font class="keywordtype">bool</font> Load(<font class="keywordtype">int</font> width, <font class="keywordtype">int</font> height,
00607             <font class="keywordtype">unsigned</font> <font class="keywordtype">char</font> *lim, <font class="keywordtype">unsigned</font> <font class="keywordtype">char</font> *rim, 
00608             <font class="keywordtype">unsigned</font> <font class="keywordtype">char</font> *cim = NULL, <font class="keywordtype">unsigned</font> <font class="keywordtype">char</font> *cimr = NULL,
00609             <font class="keywordtype">bool</font> rect = <font class="keyword">false</font>, <font class="keywordtype">bool</font> copy = <font class="keyword">false</font>);
00610 
00611   <font class="comment">// Acquire images</font>
00612   IMPORT svsStereoImage *GetImage(<font class="keywordtype">int</font> ms); <font class="comment">// returns a stereo image</font>
00613 
00614 };
00615 
00616 
00617 <font class="comment">// MMX stuff</font>
00618 
00619 <font class="preprocessor">#ifdef WIN32             // MSW definitions 
</font>00620 <font class="preprocessor"></font>
00621 <font class="preprocessor">#define ISMMX(flag) \
</font>00622 <font class="preprocessor"> __asm { \
</font>00623 <font class="preprocessor">        __asm mov  flag,1  \
</font>00624 <font class="preprocessor">        __asm mov  eax, 1 \
</font>00625 <font class="preprocessor">        __asm test edx,00800000h \
</font>00626 <font class="preprocessor">        __asm jnz nommxlab \
</font>00627 <font class="preprocessor">        __asm mov  flag, 0 \
</font>00628 <font class="preprocessor">        __asm nommxlab: mov flag,1\
</font>00629 <font class="preprocessor">} 
</font>00630 <font class="preprocessor"></font>
00631 
00632 <font class="preprocessor">#define empty_mms \
</font>00633 <font class="preprocessor">__asm { emms }
</font>00634 <font class="preprocessor"></font>
00635 <font class="preprocessor">#else
</font>00636 <font class="preprocessor"></font>
00637 <font class="preprocessor">#define ASM __asm__ volatile
</font>00638 <font class="preprocessor"></font><font class="preprocessor">#define EASM : : : "%eax" );
</font>00639 <font class="preprocessor"></font><font class="preprocessor">#define __STR(x) #x
</font>00640 <font class="preprocessor"></font><font class="preprocessor">#define STR(x) __STR(x)
</font>00641 <font class="preprocessor"></font><font class="preprocessor">#define REG(x) "%%"__STR(x)
</font>00642 <font class="preprocessor"></font><font class="preprocessor">#define BRASM ": : ); ASM ("
</font>00643 <font class="preprocessor"></font>
00644 <font class="comment">/* sets flag to 1 if MMX present, else 0 */</font>
00645 <font class="preprocessor">#define ISMMX(flag) \
</font>00646 <font class="preprocessor">ASM ( " \
</font>00647 <font class="preprocessor">        \n\t movl $1,%0  \
</font>00648 <font class="preprocessor">        \n\t movl $1,%%eax \
</font>00649 <font class="preprocessor">        \n\t cpuid \
</font>00650 <font class="preprocessor">        \n\t test $0x800000,%%edx \
</font>00651 <font class="preprocessor">        \n\t jnz .nommxlab \
</font>00652 <font class="preprocessor">        \n\t movl $0,%0 \
</font>00653 <font class="preprocessor">        \n.nommxlab:\t \
</font>00654 <font class="preprocessor">": "=m" (flag) : : "%eax", "%ebx", "%ecx", "%edx")
</font>00655 <font class="preprocessor"></font>
00656 <font class="preprocessor">#define empty_mms \
</font>00657 <font class="preprocessor">ASM (" emms ": : )
</font>00658 <font class="preprocessor"></font>
00659 <font class="preprocessor">#endif
</font>00660 <font class="preprocessor"></font>
00661 <font class="preprocessor">#endif  // svsclass_h
</font>00662 <font class="preprocessor"></font>
00663 
</div></pre><hr><address><small>Generated at Fri Oct 26 00:17:16 2007 for XVision by
<a href="http://www.stack.nl/~dimitri/doxygen/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.0 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2000</small></address>
</body>
</html>
