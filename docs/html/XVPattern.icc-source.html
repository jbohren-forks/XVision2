<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta name="robots" content="noindex">
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>/home/burschka/XVision2-2.0.0/src/Tracking/Edges/XVPattern.icc Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.0 on Fri Oct 26 00:17:16 2007 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; </center>
<hr><h1>/home/burschka/XVision2-2.0.0/src/Tracking/Edges/XVPattern.icc</h1><div class="fragment"><pre>00001 <font class="comment">// *** BEGIN_XVISION2_COPYRIGHT_NOTICE ***</font>
00002 <font class="comment">// *** END_XVISION2_COPYRIGHT_NOTICE ***</font>
00003 
00004 <font class="comment">//-----------------------------------------------------------------------------</font>
00005 <font class="comment">//</font>
00006 <font class="comment">//  XVPattern.icc</font>
00007 <font class="comment">//</font>
00008 <font class="comment">//  Definition of templates, private functions, and return structs.</font>
00009 <font class="comment">//</font>
00010 <font class="comment">//  7 - 21 - 93</font>
00011 <font class="comment">//  Sidd Puri</font>
00012 <font class="comment">//</font>
00013 <font class="comment">//  Modified for XVision2</font>
00014 <font class="comment">//  9.13.00</font>
00015 <font class="comment">//  Sam Lang</font>
00016 <font class="comment">//</font>
00017 <font class="comment">//-----------------------------------------------------------------------------</font>
00018 
00019 
00020 <font class="comment">//-----------------------------------------------------------------------------</font>
00021 <font class="comment">//  Private functions</font>
00022 <font class="comment">//-----------------------------------------------------------------------------</font>
00023 
00024 <font class="keyword">inline</font> <font class="keywordtype">void</font> sumcor (<font class="keywordtype">int</font> * sum, <font class="keywordtype">int</font> * cor, <font class="keywordtype">int</font> cwidth, <font class="keywordtype">int</font> mwidth,
00025               linetype l=any)<font class="keyword"> </font>{
00026   <font class="keywordtype">int</font> val = 0;                     <font class="comment">// initialize running value</font>
00027   <font class="keywordtype">int</font> i;
00028   <font class="keywordflow">for</font> (i = 0; i &lt; mwidth/2; i++)
00029     val -= sum[i];
00030   <font class="keywordflow">for</font> (; i &lt; mwidth; i++)
00031     val += sum[i];
00032 
00033   <font class="keywordtype">int</font> * left  = sum - 1;
00034   <font class="keywordtype">int</font> * mid   = sum - 1 + mwidth/2;
00035   <font class="keywordtype">int</font> * right = sum - 1 + mwidth;
00036 
00037   <font class="keywordflow">switch</font> (l) {
00038 
00039   <font class="keywordflow">case</font> any:
00040     
00041     cor[0] = abs (val);
00042 
00043     <font class="keywordflow">for</font> (i = 1; i &lt; cwidth; i++) {      <font class="comment">// run across the vector</font>
00044       val += left[i] - (mid[i] &lt;&lt; 1) + right[i];
00045       cor[i] = abs (val);
00046     }
00047     <font class="keywordflow">break</font>;
00048 
00049   <font class="keywordflow">case</font> lightdark:
00050 
00051     cor[0] = -val;
00052 
00053     <font class="keywordflow">for</font> (i = 1; i &lt; cwidth; i++) {      <font class="comment">// run across the vector</font>
00054       val += left[i] - ( mid[i]&lt;&lt;1) + right[i];
00055       cor[i] = -val;
00056     }
00057     <font class="keywordflow">break</font>;
00058 
00059   <font class="keywordflow">case</font> darklight:
00060   <font class="keywordflow">case</font> none:
00061 
00062     cor[0] = val;
00063     <font class="keywordflow">for</font> (i = 1; i &lt; cwidth; i++) {      <font class="comment">// run across the vector</font>
00064       val += left[i] - ( mid[i]&lt;&lt;1) + right[i];
00065       cor[i] = val;
00066     }
00067     <font class="keywordflow">break</font>;
00068 
00069   }
00070 }
00071 
00072 <font class="keyword">inline</font> XVPeak interparb (<font class="keywordtype">int</font> left, <font class="keywordtype">int</font> mid, <font class="keywordtype">int</font> right)<font class="keyword"> </font>{
00073                               <font class="comment">// apply quadratic interpolation</font>
00074   <font class="keyword">const</font> <font class="keywordtype">float</font> a = half (left - 2 * mid + right);
00075   XVPeak result;
00076 
00077   <font class="keywordflow">if</font> (fabs(a) &lt; TINY) {
00078     result.x = 0.0;
00079     result.val = mid;
00080     <font class="keywordflow">return</font> result;
00081   }
00082 
00083   <font class="keyword">const</font> <font class="keywordtype">float</font> b = half (right - left);
00084 
00085 
00086   result.x = -b / (2 * a);
00087   result.val = a * result.x * result.x + b * result.x + mid;
00088 
00089   <font class="keywordflow">return</font> result;
00090 }
00091 
00092 <font class="keyword">inline</font> XVPeak interparbangle (<font class="keywordtype">float</font> left, <font class="keywordtype">float</font> mid, <font class="keywordtype">float</font> right)<font class="keyword"> </font>{
00093                               <font class="comment">// apply quadratic interpolation</font>
00094                               <font class="comment">// for angles</font>
00095   <font class="keyword">const</font> <font class="keywordtype">float</font> a = (left - 2 * mid + right) / 2;
00096   <font class="keyword">const</font> <font class="keywordtype">float</font> b = (right - left) / 2;
00097   XVPeak result;
00098 
00099   <font class="keywordflow">if</font> (fabs(a) &lt; TINY) {
00100     <font class="keywordflow">if</font> (fabs(b) &lt; TINY) {
00101       result.x = 0.0;
00102       result.val = mid;
00103     }
00104     <font class="keywordflow">else</font>
00105       <font class="keywordflow">if</font> (right &gt; left) {
00106      result.x = 1.0;
00107      result.val = right;
00108       }
00109       <font class="keywordflow">else</font> {
00110      result.x =  -1.0;
00111      result.val = left;
00112       }
00113     <font class="keywordflow">return</font> result;
00114   }
00115 
00116   <font class="keywordflow">if</font> (a &gt;= 0) {
00117     <font class="keywordflow">if</font> (right &gt; left) {
00118       result.x = 1.0;
00119       result.val = right;
00120     }
00121     <font class="keywordflow">else</font> {
00122       result.x =  -1.0;
00123       result.val = left;
00124     }
00125   }
00126   <font class="keywordflow">else</font> {
00127     result.x = -b / (2 * a);
00128     result.val = a*result.x*result.x + b*result.x + mid;
00129   }
00130 
00131   <font class="keywordflow">return</font> result;
00132 };
00133 
00134 
00135 <font class="comment">//  inline peak interbell (float left, float mid, float right) {</font>
00136 <font class="comment">//                            // apply interpolation on a bell</font>
00137 <font class="comment">//    peak result;</font>
00138 <font class="comment">//    result.x = result.val = 0;</font>
00139 
00140 <font class="comment">//    if (fabs(mid) &lt; TINY) {</font>
00141 <font class="comment">//      return result;</font>
00142 <font class="comment">//    }</font>
00143 
00144 <font class="comment">//    float a = abs (left + right - 2 * left * right / mid);</font>
00145 <font class="comment">//    if (fabs(a) &lt; TINY) return result;</font>
00146 <font class="comment">//    result = (right - left) / (2 * a);</font>
00147 <font class="comment">//    return result;</font>
00148 <font class="comment">//  }</font>
00149 
00150 
00151 <font class="keyword">inline</font> XVPeak findpeak (<font class="keywordtype">int</font> * cor, <font class="keywordtype">int</font> cwidth, <font class="keywordtype">int</font> threshold)<font class="keyword"> </font>{
00152 
00153   XVPeak best;
00154   best.x = 0;
00155   best.val = 0;
00156 
00157   <font class="keywordflow">for</font> (<font class="keywordtype">int</font> i = 1; i &lt; cwidth - 1; i++){
00158     <font class="keywordflow">if</font> (cor[i] &gt;= cor[i - 1] &amp;&amp; cor[i] &gt;= cor[i + 1]) {
00159       XVPeak nexttry = interparb (cor[i - 1], cor[i], cor[i + 1]);
00160       <font class="keywordflow">if</font> ( nexttry.val &gt;= best.val + threshold ||
00161        (nexttry.val &gt;= best.val - threshold &amp;&amp; abs (nexttry.x) &lt; abs (best.x))) {
00162      best.x = i + nexttry.x - half (cwidth);
00163      best.val = nexttry.val;
00164       }
00165     }
00166   }
00167   <font class="keywordflow">if</font> (best.val == 0) best.val = cor[cwidth/2];
00168 
00169   <font class="keywordflow">return</font> best;
00170 }
00171 
00172 <font class="keyword">inline</font> XVPeak findpeak (<font class="keywordtype">int</font> * cor, <font class="keywordtype">int</font> cwidth, <font class="keywordtype">int</font> threshold, linetype l)<font class="keyword"> </font>{
00173 
00174   XVPeak best;
00175   best.x = 0;
00176   best.val = 0;
00177   <font class="keywordtype">int</font> i;
00178 
00179   <font class="keywordflow">if</font> (l == none) {
00180     <font class="keywordflow">for</font> (i = 1; i &lt; cwidth - 1; i++)
00181       <font class="keywordflow">if</font> (cor[i] &gt;= cor[i - 1] &amp;&amp; cor[i] &gt;= cor[i + 1]) {
00182      XVPeak nexttry = interparb (cor[i - 1], cor[i], cor[i + 1]);
00183      nexttry.x = i + nexttry.x - half (cwidth);
00184      <font class="keywordflow">if</font> ((nexttry.val - (nexttry.x+1)*threshold) &gt; 
00185          ((best.val) - (best.x+1)*threshold)) {
00186        best.x = nexttry.x;
00187        best.val = nexttry.val;
00188      }
00189       }
00190 
00191     <font class="keywordflow">for</font> (i = 1; i &lt; cwidth - 1; i++)
00192       <font class="keywordflow">if</font> (-cor[i] &gt;= -cor[i - 1] &amp;&amp; -cor[i] &gt;= -cor[i + 1]) {
00193      XVPeak nexttry = interparb (-cor[i - 1], -cor[i], -cor[i + 1]);
00194      nexttry.x = i + nexttry.x - half (cwidth);
00195      <font class="keywordflow">if</font> ((nexttry.val - (nexttry.x+1)*threshold) &gt; 
00196          ((abs(best.val)) - (best.x+1)*threshold)) {
00197        best.x = nexttry.x;
00198        best.val = -nexttry.val;
00199      }
00200       }
00201   }
00202   <font class="keywordflow">else</font> {
00203     <font class="keywordtype">int</font> besti = 1;
00204     <font class="keywordflow">for</font> (i = 2; i &lt; cwidth - 1; i++)
00205       <font class="keywordflow">if</font> (cor[i] &gt;= cor[besti])    besti  = i;
00206     
00207     <font class="keywordflow">if</font> (cor[besti] &gt; threshold) {
00208       best = interparb (cor[besti - 1], cor[besti], cor[besti + 1]);
00209       best.x = besti + best.x - half (cwidth);
00210     }
00211   }
00212 
00213   <font class="keywordflow">if</font> (best.val == 0) best.val = cor[cwidth/2];
00214 
00215   <font class="keywordflow">return</font> best;
00216 }
00217 
00218 <font class="keyword">static</font> <font class="keywordtype">float</font> average (XVPeak  a, XVPeak  b, XVPeak c)<font class="keyword"> </font>{
00219   <font class="keywordflow">return</font> (a.x * a.val + b.x * b.val + c.x * c.val) / (a.val + b.val + c.val);
00220 }
00221 
00222 <font class="comment">//- mode computation ---------------------------------------------------</font>
00223 <font class="comment">//   Output is x, where all numbers from x to x+(DIVBY-1) were thrown</font>
00224 <font class="comment">//      into bin x/HALF_DIVBY, and that bin contained the most numbers</font>
00225 <font class="comment">//      after tally (in case of tie, first such bin is chosen).</font>
00226 <font class="comment">//----------------------------------------------------------------------</font>
00227 
00228 <font class="keywordtype">int</font> <font class="keyword">const</font> NUMBINS = 26;                   <font class="comment">// NUMBINS * DIVBY ~= 256</font>
00229 <font class="keywordtype">int</font> <font class="keyword">const</font> DIVBY = 10;
00230 <font class="keywordtype">int</font> <font class="keyword">const</font> HALF_DIVBY = 5;
00231 
00232 <font class="preprocessor">#include &lt;string.h&gt;</font>
00233 
00234 <font class="keyword">inline</font> <font class="keywordtype">int</font> mode (<font class="keywordtype">int</font> *arr, <font class="keywordtype">int</font> start, <font class="keywordtype">int</font> finish)<font class="keyword"> </font>{
00235   <font class="keywordtype">int</font> i;
00236   <font class="keywordtype">int</font> max=0;
00237   <font class="keywordtype">int</font> bin[NUMBINS*2];
00238 
00239   memset(bin, 0, <font class="keyword">sizeof</font>(<font class="keywordtype">int</font>)*NUMBINS*2);
00240 
00241   <font class="keywordflow">for</font> (i=start;i&lt;finish;i++) 
00242     bin[2*(arr[i]/DIVBY)] += 1;
00243   <font class="keywordflow">for</font> (i=start;i&lt;finish;i++)
00244     bin[2*((arr[i]+(HALF_DIVBY))/DIVBY)-1] += 1; 
00245   
00246   <font class="keywordflow">for</font> (i=0;i&lt;NUMBINS*2;i++) {
00247     <font class="keywordflow">if</font> (bin[i] &gt;bin[max]) max = i;
00248   }
00249 
00250   <font class="keywordflow">return</font> max*(HALF_DIVBY);
00251 }
00252 
00253 <font class="comment">//- findpeaks ------------------------------------------------------------</font>
00254 <font class="comment">//   Find all peaks and compute mode values between peaks and boundaries.</font>
00255 <font class="comment">//   Return output in SE_out structure,  data .</font>
00256 <font class="comment">//------------------------------------------------------------------------</font>
00257 
00258 <font class="keywordtype">int</font> <font class="keyword">const</font> UP = 1;
00259 <font class="keywordtype">int</font> <font class="keyword">const</font> DOWN = 0;
00260 
00261 <font class="keyword">inline</font> <font class="keywordtype">int</font> findpeaks (<font class="keywordtype">int</font> *cors, <font class="keywordtype">int</font> *is, <font class="keywordtype">int</font> cwidth, <font class="keywordtype">int</font>, 
00262                 <font class="keywordtype">int</font> thresh)<font class="keyword"> </font>{ <font class="comment">// , SE_out *data) {</font>
00263   <font class="keywordtype">int</font> i, last;
00264   <font class="keywordtype">int</font> pks = 0;
00265 
00266   <font class="keywordtype">int</font> *cordiffs = <font class="keyword">new</font> <font class="keywordtype">int</font>[cwidth];
00267 
00268   <font class="comment">// compute direction of slope (UP or DOWN)</font>
00269   <font class="keywordflow">for</font> (i=0;i&lt;cwidth;i++)
00270     <font class="keywordflow">if</font> ((cors[i] &gt; thresh) &amp;&amp; (cors[i] &gt; cors[i+1]))
00271       cordiffs[i] = DOWN;
00272     <font class="keywordflow">else</font>
00273       cordiffs[i] = UP;
00274 
00275 <font class="comment">//  SLANG - need to fix SE_out.imval before uncommenting</font>
00276 
00277 <font class="comment">//    // find peaks (defined as an UP-DOWN sequence)</font>
00278 <font class="comment">//    last = cordiffs[0];</font>
00279 <font class="comment">//    for (i=1;i&lt;cwidth;i++) {</font>
00280 <font class="comment">//      if ((last == UP) &amp;&amp; (cordiffs[i] == DOWN)) {</font>
00281 <font class="comment">//        data-&gt;pk[pks] = i; </font>
00282 <font class="comment">//        data-&gt;pkstrength[pks] = cors[i];      // would i+1 be better?</font>
00283 <font class="comment">//        pks++;</font>
00284 <font class="comment">//      }</font>
00285 <font class="comment">//      last = cordiffs[i];</font>
00286 <font class="comment">//    }</font>
00287 
00288 <font class="comment">//    // compute mode values between peaks</font>
00289 <font class="comment">//    data-&gt;regionmode[0] = mode(is, 0, data-&gt;pk[0]-1);</font>
00290 <font class="comment">//    for (i=1;i&lt;pks;i++)</font>
00291 <font class="comment">//      data-&gt;regionmode[i] = mode(is, data-&gt;pk[i-1],data-&gt;pk[i]-1);</font>
00292 <font class="comment">//    data-&gt;regionmode[pks] = mode(is, data-&gt;pk[pks-1], cwidth-1); </font>
00293 
00294   <font class="keyword">delete</font> [] cordiffs;
00295   <font class="keywordflow">return</font> pks;
00296 };
00297 
00298 <font class="keyword">inline</font> <font class="keywordtype">int</font> modsum(<font class="keywordtype">int</font> sum, linetype l)<font class="keyword"></font>{
00299   <font class="keywordflow">switch</font>(l) {
00300   <font class="keywordflow">case</font> lightdark:
00301     sum = -sum;
00302     <font class="keywordflow">break</font>;
00303   <font class="keywordflow">case</font> any:
00304     sum = abs(sum);
00305     <font class="keywordflow">break</font>;
00306   <font class="keywordflow">case</font> darklight:
00307   <font class="keywordflow">case</font> none:
00308     ;  <font class="comment">//panic("modsum"); // ToDo: is this right? ADR</font>
00309   }
00310 
00311   <font class="keywordflow">return</font> sum;
00312 };
00313 
00314   
00315 <font class="comment">//  // Just for debugging Shortedge stuff.</font>
00316 <font class="comment">//  void printSE_outp (SE_out *s, int wid, char *src = "") {</font>
00317 <font class="comment">//    int i,k=0;</font>
00318 <font class="comment">//    printf ("%s: SE_out: \n",src);</font>
00319 <font class="comment">//    printf ("   numpks: %d\n",s-&gt;numpks);</font>
00320 <font class="comment">//    printf ("   num     imval     pk      pkstrength     regionmode \n");</font>
00321 <font class="comment">//    for (i=0;i&lt;wid; i++) {</font>
00322 <font class="comment">//      if (s-&gt;pk[k] == i) { </font>
00323 <font class="comment">//        printf ("   %2d:     %3d        %2d       %7d          %3d\n",</font>
00324 <font class="comment">//         i,   s-&gt;imval[i], s-&gt;pk[k], s-&gt;pkstrength[k], s-&gt;regionmode[k]);</font>
00325 <font class="comment">//        k++;</font>
00326 <font class="comment">//      } else {</font>
00327 <font class="comment">//        printf ("   %2d:     %3d\n",i,s-&gt;imval[i]);</font>
00328 <font class="comment">//      }</font>
00329 <font class="comment">//    }</font>
00330 <font class="comment">//    printf ("     :                                         %3d\n",</font>
00331 <font class="comment">//     s-&gt;regionmode[k]);</font>
00332 <font class="comment">//  };</font>
</div></pre><hr><address><small>Generated at Fri Oct 26 00:17:16 2007 for XVision by
<a href="http://www.stack.nl/~dimitri/doxygen/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.0 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2000</small></address>
</body>
</html>
